#!/bin/bash

# compiler invocations that should do about the same thing as the real build system.
#
# may be used
#   - for understanding what the 'big' buildsystem actually does
#   - as an last resort, if you can't get cmake to work
#   - if you ever wanted to do a single g++ invocation that takes serveral minutes to complete
#
# depending on your distribution and current decade, minor to major adjustments may be neccesary.
#
# this script was written by carefully looking at the output of make VERBOSE=1.
# if you add libraries/etc to the project, please update this script accordingly (and test it).

PYVER=3.4m
PYVERDOTLESS=34m
shopt -s globstar

# build py ext module (openage.convert.cabextract.lzxd)
CPATH=/usr/i686-w64-mingw32/include
i686-w64-mingw32-g++ -O3 -Wall -Wextra -Wno-format -pedantic -std=c++11 -DWITH_INOTIFY=0 -DDYNAMIC_ANNOTATIONS_ENABLED=1 -DNDEBUG -fwrapv --param=ssp-buffer-size=4 -I/usr/i686-w64-mingw32/include/python${PYVER} -shared -Wl,-O1,--sort-common,--as-needed  -o py/openage/convert/cabextract/lzxd.cpython-${PYVERDOTLESS}.so py/openage/convert/cabextract/lzxd/{lzxd.cpp,pyinterface.cpp,util.cpp} -lpython${PYVER} -lpthread

# these files would be filled with actual test lists by testing.cmake
touch assets/tests_py assets/tests_cpp
# this file would be generated by cmake
echo "global_asset_dir = '/usr/share/openage'" > py/openage/config.py
echo "version = '`cat openage_version`'" >> py/openage/config.py

# generate C code from convert script
PYTHONPATH="$PYTHONPATH:py" python3 -m openage.codegen --target-cache=/tmp/codegentargets --depend-cache=/tmp/codegendepends --cpp-src-dir=cpp --write-to-sourcedir

# build binary (bin/openage)
i686-w64-mingw32-g++ -O3 -Wall -Wextra -Wno-format -pedantic -std=c++11 -D__STDC_FORMAT_MACROS -I/usr/i686-w64-mingw32/include/freetype2 -I/usr/i686-w64-mingw32/include/FTGL -I/usr/i686-w64-mingw32/include/libpng16 -I/usr/i686-w64-mingw32/include/harfbuzz -I/usr/i686-w64-mingw32/include/opus -I/usr/i686-w64-mingw32/include/python${PYVER} -I/usr/i686-w64-mingw32/include/SDL2  -o openage cpp/**/*.cpp -lpython${PYVER} -lfontconfig -lfreetype -lftgl -lm -lopusfile -lpthread -lSDL2 -lglew32 -lopengl32 -lmingw32 -lSDL2_image  -lSDL2main -lSDL2 -mwindows
